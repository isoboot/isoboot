syntax = "proto3";

package isoboot.controller.v1;

option go_package = "github.com/isoboot/isoboot/api/controllerpb";

// ControllerService handles deploy lifecycle and template management
service ControllerService {
  // GetPendingBoot returns boot info for a MAC with pending deploy
  rpc GetPendingBoot(GetPendingBootRequest) returns (GetPendingBootResponse);

  // MarkBootStarted marks a deploy as InProgress
  rpc MarkBootStarted(MarkBootStartedRequest) returns (MarkBootStartedResponse);

  // MarkBootCompleted marks a deploy as Complete
  rpc MarkBootCompleted(MarkBootCompletedRequest) returns (MarkBootCompletedResponse);

  // GetTemplate retrieves a boot template from ConfigMap
  rpc GetTemplate(GetTemplateRequest) returns (GetTemplateResponse);

  // GetBootTarget retrieves a BootTarget by name
  rpc GetBootTarget(GetBootTargetRequest) returns (GetBootTargetResponse);

  // GetResponseTemplate retrieves a ResponseTemplate by name
  rpc GetResponseTemplate(GetResponseTemplateRequest) returns (GetResponseTemplateResponse);

  // GetRenderedTemplate renders a template file for a deploy
  rpc GetRenderedTemplate(GetRenderedTemplateRequest) returns (GetRenderedTemplateResponse);
}

message GetPendingBootRequest {
  string mac = 1;
}

message GetPendingBootResponse {
  bool found = 1;
  string machine_name = 2;
  string deploy_name = 3;
  string target = 4;
}

message MarkBootStartedRequest {
  string mac = 1;
}

message MarkBootStartedResponse {
  bool success = 1;
  string error = 2;
}

message MarkBootCompletedRequest {
  string hostname = 1;
}

message MarkBootCompletedResponse {
  bool success = 1;
  string error = 2;
}

message GetTemplateRequest {
  string name = 1;
  string configmap = 2;
}

message GetTemplateResponse {
  bool found = 1;
  string content = 2;
}

message GetBootTargetRequest {
  string name = 1;
}

message GetBootTargetResponse {
  bool found = 1;
  string disk_image_ref = 2;
  string template = 3;
}

message GetResponseTemplateRequest {
  string name = 1;
}

message GetResponseTemplateResponse {
  bool found = 1;
  map<string, string> files = 2;
}

message GetRenderedTemplateRequest {
  string hostname = 1;
  string filename = 2;
}

message GetRenderedTemplateResponse {
  bool found = 1;
  string content = 2;
  string error = 3;
}
