syntax = "proto3";

package isoboot.controller.v1;

option go_package = "github.com/isoboot/isoboot/api/controllerpb";

// ControllerService provides primitive CRD access for isoboot resources
service ControllerService {
  // GetMachineByMAC retrieves a Machine by MAC address
  rpc GetMachineByMAC(GetMachineByMACRequest) returns (GetMachineByMACResponse);

  // GetMachine retrieves a Machine by name
  rpc GetMachine(GetMachineRequest) returns (GetMachineResponse);

  // GetProvisionsByMachine retrieves all Provisions referencing a Machine
  rpc GetProvisionsByMachine(GetProvisionsByMachineRequest) returns (GetProvisionsByMachineResponse);

  // UpdateProvisionStatus updates a Provision's status
  rpc UpdateProvisionStatus(UpdateProvisionStatusRequest) returns (UpdateProvisionStatusResponse);

  // GetConfigMapValue retrieves a value from a ConfigMap by key
  rpc GetConfigMapValue(GetConfigMapValueRequest) returns (GetConfigMapValueResponse);

  // GetBootTarget retrieves a BootTarget by name
  rpc GetBootTarget(GetBootTargetRequest) returns (GetBootTargetResponse);

  // GetBootMedia retrieves a BootMedia by name
  rpc GetBootMedia(GetBootMediaRequest) returns (GetBootMediaResponse);

  // GetResponseTemplate retrieves a ResponseTemplate by name
  rpc GetResponseTemplate(GetResponseTemplateRequest) returns (GetResponseTemplateResponse);

  // GetProvision retrieves a Provision by name
  rpc GetProvision(GetProvisionRequest) returns (GetProvisionResponse);

  // GetConfigMaps retrieves and merges data from multiple ConfigMaps
  rpc GetConfigMaps(GetConfigMapsRequest) returns (GetConfigMapsResponse);

  // GetSecrets retrieves and merges data from multiple Secrets
  rpc GetSecrets(GetSecretsRequest) returns (GetSecretsResponse);

  // GetDiskImage retrieves a DiskImage by name
  rpc GetDiskImage(GetDiskImageRequest) returns (GetDiskImageResponse);
}

message GetMachineByMACRequest {
  string mac = 1;
}

message GetMachineByMACResponse {
  bool found = 1;
  string name = 2;
}

message GetMachineRequest {
  string name = 1;
}

message GetMachineResponse {
  bool found = 1;
  string mac = 2;
}

message GetProvisionsByMachineRequest {
  string machine_name = 1;
}

message ProvisionSummary {
  string name = 1;
  string status = 2;
  string boot_target_ref = 3;
}

message GetProvisionsByMachineResponse {
  repeated ProvisionSummary provisions = 1;
}

message UpdateProvisionStatusRequest {
  string name = 1;
  string status = 2;
  string message = 3;
  string ip = 4;  // Optional: IP address for completion tracking
}

message UpdateProvisionStatusResponse {
  bool success = 1;
  string error = 2;
}

message GetConfigMapValueRequest {
  string configmap_name = 1;
  string key = 2;
}

message GetConfigMapValueResponse {
  bool found = 1;
  string value = 2;
}

message GetBootTargetRequest {
  string name = 1;
}

message GetBootTargetResponse {
  bool found = 1;
  string disk_image = 2;          // deprecated: use boot_media_ref
  string template = 3;
  string include_firmware_path = 4; // deprecated: use use_firmware
  string boot_media_ref = 5;
  bool use_firmware = 6;
}

message GetBootMediaRequest {
  string name = 1;
}

message GetBootMediaResponse {
  bool found = 1;
  string kernel_filename = 2;
  string initrd_filename = 3;
  bool has_firmware = 4;
}

message GetResponseTemplateRequest {
  string name = 1;
}

message GetResponseTemplateResponse {
  bool found = 1;
  map<string, string> files = 2;
}

message GetProvisionRequest {
  string name = 1;
}

message GetProvisionResponse {
  bool found = 1;
  string machine_ref = 2;
  string boot_target_ref = 3;
  string response_template_ref = 4;
  repeated string config_maps = 5;
  repeated string secrets = 6;
  string machine_id = 7;  // Optional systemd machine-id
}

message GetConfigMapsRequest {
  repeated string names = 1;
}

message GetConfigMapsResponse {
  bool found = 1;
  map<string, string> data = 2;
  string error = 3;
}

message GetSecretsRequest {
  repeated string names = 1;
}

message GetSecretsResponse {
  bool found = 1;
  map<string, string> data = 2;
  string error = 3;
}

message GetDiskImageRequest {
  string name = 1;
}

message GetDiskImageResponse {
  bool found = 1;
  string iso_filename = 2;
}
