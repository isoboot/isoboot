set -eu
apk add --no-cache wget
{{- $tasks := . }}
{{- range $i, $t := $tasks }}
if [ ! -f '{{ $t.OutputPath }}' ]; then
  mkdir -p '{{ $t.OutputDir }}'
  echo '{{ $t.URL | b64enc }}' | base64 -d > '/tmp/url_{{ $t.Index }}.txt'
  wget -q -i '/tmp/url_{{ $t.Index }}.txt' -O '{{ $t.OutputPath }}'
  rm -f '/tmp/url_{{ $t.Index }}.txt'
else
  echo 'SKIP {{ $t.OutputPath }} (already exists)'
fi
{{- end }}
VERIFY_FAILED=0
{{- range $i, $t := $tasks }}
{{- if eq (mod $i 2) 1 }}
{{- $bin := index $tasks (sub $i 1) }}
HASH_LINE=$(awk -v path='{{ relpath $bin.URL $t.URL }}' '$2==path || $2=="./"path || $2=="*"path || $2=="*./"path {print; exit}' '{{ $t.OutputPath }}')
EXPECTED=""
ALGO=""
for word in $HASH_LINE; do
  case "$word" in
    *[!0-9a-fA-F]*) continue ;;
  esac
  WORD_LEN=${#word}
  if [ "$WORD_LEN" -eq 64 ]; then
    EXPECTED=$(echo "$word" | tr 'A-F' 'a-f')
    ALGO=SHA256
    break
  elif [ "$WORD_LEN" -eq 128 ]; then
    EXPECTED=$(echo "$word" | tr 'A-F' 'a-f')
    ALGO=SHA512
    break
  fi
done
if [ -z "$ALGO" ]; then
  echo "ERROR: no valid hash found for {{ $bin.OutputPath }}" >&2
  rm -f '{{ $bin.OutputPath }}'
  VERIFY_FAILED=1
else
  if [ "$ALGO" = "SHA256" ]; then
    ACTUAL=$(sha256sum '{{ $bin.OutputPath }}' | awk '{print $1}')
  else
    ACTUAL=$(sha512sum '{{ $bin.OutputPath }}' | awk '{print $1}')
  fi
  echo "Expected ($ALGO): $EXPECTED"
  echo "Actual   ($ALGO): $ACTUAL"
  if [ "$EXPECTED" = "$ACTUAL" ]; then
    echo "PASS: {{ $bin.OutputPath }}"
  else
    echo "FAIL: {{ $bin.OutputPath }}" >&2
    rm -f '{{ $bin.OutputPath }}'
    VERIFY_FAILED=1
  fi
fi
{{- end }}
{{- end }}
echo "--- File sizes ---"
{{- range $i, $t := $tasks }}
{{- if eq (mod $i 2) 0 }}
du -h '{{ $t.OutputPath }}' 2>/dev/null || echo '{{ $t.OutputPath }}: not found'
{{- end }}
{{- end }}
if [ "$VERIFY_FAILED" -eq 1 ]; then
  exit 1
fi
