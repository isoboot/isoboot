#!/bin/sh
set -e

DIR="{{.Dir}}"
mkdir -p "$DIR"

# ── Download phase ──────────────────────────────────────────────
{{range .Files -}}
echo ">> Checking {{.Name}}..."
if [ -f "{{.Dest}}" ] && [ -s "{{.Dest}}" ]; then
  echo "   SKIP: {{.Name}} already exists at {{.Dest}}"
else
  echo "   DOWNLOADING: {{.Name}} from {{.URL}}"
  mkdir -p "$(dirname "{{.Dest}}")"
  rm -f "{{.Dest}}" "{{.Dest}}.tmp"
  wget --timeout=300 --tries=3 -O "{{.Dest}}.tmp" "{{.URL}}"
  mv "{{.Dest}}.tmp" "{{.Dest}}"
  echo "   DONE: {{.Name}}"
fi
{{end}}
# ── Verify phase ────────────────────────────────────────────────
{{range .Files -}}
{{if .ShasumURL -}}
echo ">> Verifying {{.Name}}..."
wget --timeout=300 --tries=3 -O "{{.Dest}}.shasum" "{{.ShasumURL}}"
HASH_SAMPLE=$(grep -oEm1 '[0-9a-f]{64,128}' "{{.Dest}}.shasum" | head -1 || true)
HASH_LEN=${#HASH_SAMPLE}
if [ "$HASH_LEN" -eq 128 ]; then
  TOOL=sha512sum
elif [ "$HASH_LEN" -eq 64 ]; then
  TOOL=sha256sum
elif [ "$HASH_LEN" -eq 0 ]; then
  echo "   FAIL: no hash found in {{.ShasumURL}}"
  echo "         Only SHA256 (64 chars) and SHA512 (128 chars) are supported."
  exit 1
else
  echo "   FAIL: unsupported hash length ($HASH_LEN) in {{.ShasumURL}}"
  echo "         Only SHA256 (64 chars) and SHA512 (128 chars) are supported."
  exit 1
fi
OUR_HASH=$($TOOL "{{.Dest}}" | awk '{print $1}')
BASENAME="{{.URLBasename}}"
EXPECTED_HASH=$(awk -v name="$BASENAME" '$2 == name || $2 == ("*" name) { print $1; exit }' "{{.Dest}}.shasum")
if [ -z "$EXPECTED_HASH" ]; then
  echo "   FAIL: no hash entry found for $BASENAME in shasum file"
  cat "{{.Dest}}.shasum"
  exit 1
fi
if [ "$OUR_HASH" != "$EXPECTED_HASH" ]; then
  echo "   FAIL: hash mismatch for $BASENAME (expected $EXPECTED_HASH, got $OUR_HASH)"
  exit 1
fi
echo "   VERIFIED: {{.Name}} ($TOOL, $BASENAME)"
rm -f "{{.Dest}}.shasum"
{{end -}}
{{end}}
{{- if .ISO}}
# ── Extract phase ───────────────────────────────────────────────
echo ">> Extracting kernel and initrd from ISO..."
MNTDIR="$(mktemp -d)"
cleanup() { umount "$MNTDIR" 2>/dev/null; rmdir "$MNTDIR" 2>/dev/null; }
trap cleanup EXIT
mount -o ro,loop "{{.ISO.ISOPath}}" "$MNTDIR"
mkdir -p "$DIR/kernel"
cp "$MNTDIR/{{.ISO.KernelPath}}" "$DIR/kernel/{{.ISO.KernelBasename}}.tmp" && mv "$DIR/kernel/{{.ISO.KernelBasename}}.tmp" "$DIR/kernel/{{.ISO.KernelBasename}}"
echo "   EXTRACTED: kernel/{{.ISO.KernelBasename}} from {{.ISO.KernelPath}}"
mkdir -p "$DIR/initrd"
cp "$MNTDIR/{{.ISO.InitrdPath}}" "$DIR/initrd/{{.ISO.InitrdBasename}}.tmp" && mv "$DIR/initrd/{{.ISO.InitrdBasename}}.tmp" "$DIR/initrd/{{.ISO.InitrdBasename}}"
echo "   EXTRACTED: initrd/{{.ISO.InitrdBasename}} from {{.ISO.InitrdPath}}"
{{- if .ISO.FirmwarePath}}
mkdir -p "$DIR/firmware"
cp "$MNTDIR/{{.ISO.FirmwarePath}}" "$DIR/firmware/{{.ISO.FirmwareBasename}}.tmp" && mv "$DIR/firmware/{{.ISO.FirmwareBasename}}.tmp" "$DIR/firmware/{{.ISO.FirmwareBasename}}"
echo "   EXTRACTED: firmware/{{.ISO.FirmwareBasename}} from {{.ISO.FirmwarePath}}"
{{- end}}
umount "$MNTDIR"
rmdir "$MNTDIR"
trap - EXIT
{{- if .ISO.FirmwarePath}}
echo ">> Building initrd with firmware..."
mkdir -p "$DIR/initrd/with-firmware"
cat "$DIR/initrd/{{.ISO.InitrdBasename}}" "$DIR/firmware/{{.ISO.FirmwareBasename}}" > "$DIR/initrd/with-firmware/{{.ISO.InitrdBasename}}.tmp" && mv "$DIR/initrd/with-firmware/{{.ISO.InitrdBasename}}.tmp" "$DIR/initrd/with-firmware/{{.ISO.InitrdBasename}}"
echo "   DONE: initrd/with-firmware/{{.ISO.InitrdBasename}} ($(du -h "$DIR/initrd/with-firmware/{{.ISO.InitrdBasename}}" | awk '{print $1}'))"
{{- end}}
{{- end}}
{{- if .FirmwareConcat}}
# ── Build initrd with firmware (non-ISO) ────────────────────────
echo ">> Building initrd with firmware..."
mkdir -p "$DIR/initrd/with-firmware"
cat "$DIR/initrd/{{.FirmwareConcat.InitrdBasename}}" "$DIR/firmware/{{.FirmwareConcat.FirmwareBasename}}" > "$DIR/initrd/with-firmware/{{.FirmwareConcat.InitrdBasename}}.tmp" && mv "$DIR/initrd/with-firmware/{{.FirmwareConcat.InitrdBasename}}.tmp" "$DIR/initrd/with-firmware/{{.FirmwareConcat.InitrdBasename}}"
echo "   DONE: initrd/with-firmware/{{.FirmwareConcat.InitrdBasename}} ($(du -h "$DIR/initrd/with-firmware/{{.FirmwareConcat.InitrdBasename}}" | awk '{print $1}'))"
{{- end}}

# ── Summary ─────────────────────────────────────────────────────
echo ">> File sizes:"
find "$DIR" -type f ! -name "*.tmp" | sort | while read -r path; do
  size=$(du -h "$path" | awk '{print $1}')
  echo "   $size  ${path#$DIR/}"
done

echo ">> All done!"
