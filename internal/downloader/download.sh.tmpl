#!/bin/sh
set -e

DIR="{{.Dir}}"
mkdir -p "$DIR"

# ── Download phase ──────────────────────────────────────────────
{{range .Files -}}
echo ">> Checking {{.Name}}..."
if [ -f "{{.Dest}}" ]; then
  echo "   SKIP: {{.Name}} already exists at {{.Dest}}"
else
  echo "   DOWNLOADING: {{.Name}} from {{.URL}}"
  mkdir -p "$(dirname "{{.Dest}}")"
  wget -O "{{.Dest}}.tmp" "{{.URL}}"
  mv "{{.Dest}}.tmp" "{{.Dest}}"
  echo "   DONE: {{.Name}}"
fi
{{end}}
# ── Verify phase ────────────────────────────────────────────────
{{range .Files -}}
{{if .ShasumURL -}}
echo ">> Verifying {{.Name}}..."
wget -O "{{.Dest}}.shasum" "{{.ShasumURL}}"
HASH_SAMPLE=$(grep -oEm1 '[0-9a-f]{64,128}' "{{.Dest}}.shasum" | head -1)
HASH_LEN=${#HASH_SAMPLE}
if [ "$HASH_LEN" -eq 128 ]; then
  TOOL=sha512sum
elif [ "$HASH_LEN" -eq 64 ]; then
  TOOL=sha256sum
else
  echo "   FAIL: cannot detect hash type (length=$HASH_LEN) in {{.ShasumURL}}"
  exit 1
fi
OUR_HASH=$($TOOL "{{.Dest}}" | awk '{print $1}')
BASENAME="{{.URLBasename}}"
if ! grep "$OUR_HASH" "{{.Dest}}.shasum" | grep -q "$BASENAME"; then
  echo "   FAIL: hash $OUR_HASH not found for $BASENAME in shasum file"
  cat "{{.Dest}}.shasum"
  exit 1
fi
echo "   VERIFIED: {{.Name}} ($TOOL, $BASENAME)"
{{end -}}
{{end}}
{{- if .ISO}}
# ── Extract phase ───────────────────────────────────────────────
echo ">> Extracting kernel and initrd from ISO..."
MNTDIR="$(mktemp -d)"
mount -o ro,loop "{{.ISO.ISOPath}}" "$MNTDIR"
mkdir -p "$DIR/kernel"
cp "$MNTDIR/{{.ISO.KernelPath}}" "$DIR/kernel/{{.ISO.KernelBasename}}.tmp" && mv "$DIR/kernel/{{.ISO.KernelBasename}}.tmp" "$DIR/kernel/{{.ISO.KernelBasename}}"
echo "   EXTRACTED: kernel/{{.ISO.KernelBasename}} from {{.ISO.KernelPath}}"
mkdir -p "$DIR/initrd"
cp "$MNTDIR/{{.ISO.InitrdPath}}" "$DIR/initrd/{{.ISO.InitrdBasename}}.tmp" && mv "$DIR/initrd/{{.ISO.InitrdBasename}}.tmp" "$DIR/initrd/{{.ISO.InitrdBasename}}"
echo "   EXTRACTED: initrd/{{.ISO.InitrdBasename}} from {{.ISO.InitrdPath}}"
{{- if .ISO.FirmwarePath}}
mkdir -p "$DIR/firmware"
cp "$MNTDIR/{{.ISO.FirmwarePath}}" "$DIR/firmware/{{.ISO.FirmwareBasename}}.tmp" && mv "$DIR/firmware/{{.ISO.FirmwareBasename}}.tmp" "$DIR/firmware/{{.ISO.FirmwareBasename}}"
echo "   EXTRACTED: firmware/{{.ISO.FirmwareBasename}} from {{.ISO.FirmwarePath}}"
{{- end}}
umount "$MNTDIR"
rmdir "$MNTDIR"
{{- if .ISO.FirmwarePath}}
echo ">> Building initrd with firmware..."
mkdir -p "$DIR/initrd/with-firmware"
cat "$DIR/initrd/{{.ISO.InitrdBasename}}" "$DIR/firmware/{{.ISO.FirmwareBasename}}" > "$DIR/initrd/with-firmware/{{.ISO.InitrdBasename}}.tmp" && mv "$DIR/initrd/with-firmware/{{.ISO.InitrdBasename}}.tmp" "$DIR/initrd/with-firmware/{{.ISO.InitrdBasename}}"
echo "   DONE: initrd/with-firmware/{{.ISO.InitrdBasename}} ($(du -h "$DIR/initrd/with-firmware/{{.ISO.InitrdBasename}}" | awk '{print $1}'))"
{{- end}}
{{- end}}

# ── Summary ─────────────────────────────────────────────────────
echo ">> File sizes:"
du -h "$DIR"/*/* 2>/dev/null | while read -r size path; do
  echo "   $size  ${path#$DIR/}"
done

echo ">> All done!"
