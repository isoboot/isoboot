suite: serviceaccount tests
templates:
  - templates/serviceaccount.yaml
tests:
  # Positive Tests
  - it: should create service account by default
    asserts:
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: RELEASE-NAME-isoboot

  - it: should have automountServiceAccountToken enabled
    asserts:
      - equal:
          path: automountServiceAccountToken
          value: true

  - it: should include standard labels
    asserts:
      - isNotEmpty:
          path: metadata.labels["helm.sh/chart"]
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: isoboot
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
      - equal:
          path: metadata.labels["app.kubernetes.io/managed-by"]
          value: Helm

  - it: should use release name in SA name
    release:
      name: my-release
    asserts:
      - equal:
          path: metadata.name
          value: my-release-isoboot

  - it: should use custom name when specified
    set:
      serviceAccount.name: custom-sa-name
    asserts:
      - equal:
          path: metadata.name
          value: custom-sa-name

  - it: should add annotations when specified
    set:
      serviceAccount.annotations:
        eks.amazonaws.com/role-arn: arn:aws:iam::123456789:role/isoboot
    asserts:
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: arn:aws:iam::123456789:role/isoboot

  # Negative Tests
  - it: should not create service account when disabled
    set:
      serviceAccount.create: false
      serviceAccount.name: external-sa
    asserts:
      - hasDocuments:
          count: 0

  - it: should not include annotations when empty
    asserts:
      - isNull:
          path: metadata.annotations
