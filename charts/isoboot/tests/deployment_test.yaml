suite: deployment tests
templates:
  - templates/deployment.yaml
tests:
  # Positive Tests - Basic Structure
  - it: should render deployment with default values
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-isoboot
      - equal:
          path: spec.replicas
          value: 1
      - equal:
          path: spec.template.spec.containers[0].name
          value: manager

  - it: should use correct image with default tag
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: ghcr.io/isoboot/isoboot:0.1.0

  - it: should set base-dir argument correctly
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: --base-dir=/var/lib/isoboot

  - it: should disable leader election by default
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].args
          content: --leader-elect

  - it: should enable leader election when configured
    set:
      controller.leaderElection.enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: --leader-elect

  - it: should configure health probes on port 8081
    asserts:
      - equal:
          path: spec.template.spec.containers[0].ports[0].name
          value: health
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 8081
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /healthz
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: health
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /readyz
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: health

  - it: should set security context for non-root user
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsUser
          value: 65532
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false

  - it: should set resource limits and requests
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 512Mi
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 500m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 256Mi
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 250m

  # Positive Tests - hostPath Volume
  - it: should use hostPath volume with default path
    asserts:
      - equal:
          path: spec.template.spec.volumes[0].name
          value: boot-data
      - equal:
          path: spec.template.spec.volumes[0].hostPath.path
          value: /var/lib/isoboot

  - it: should use custom hostPath when specified
    set:
      storage.hostPath.path: /custom/boot/path
    asserts:
      - equal:
          path: spec.template.spec.volumes[0].hostPath.path
          value: /custom/boot/path

  - it: should use Directory type by default
    asserts:
      - equal:
          path: spec.template.spec.volumes[0].hostPath.type
          value: Directory

  - it: should mount volume at baseDir
    asserts:
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[0].name
          value: boot-data
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[0].mountPath
          value: /var/lib/isoboot

  # Positive Tests - Custom Values
  - it: should use custom image tag when specified
    set:
      image.tag: v1.2.3
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: ghcr.io/isoboot/isoboot:v1.2.3

  - it: should use custom repository when specified
    set:
      image.repository: custom-registry.io/isoboot
      image.tag: latest
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: custom-registry.io/isoboot:latest

  - it: should use custom baseDir when specified
    set:
      controller.baseDir: /custom/path
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: --base-dir=/custom/path
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[0].mountPath
          value: /custom/path

  - it: should set pod annotations when specified
    set:
      podAnnotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
    asserts:
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/scrape"]
          value: "true"
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/port"]
          value: "8080"

  - it: should set node selector when specified
    set:
      nodeSelector:
        kubernetes.io/os: linux
        node-type: worker
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector["kubernetes.io/os"]
          value: linux
      - equal:
          path: spec.template.spec.nodeSelector["node-type"]
          value: worker

  - it: should set tolerations when specified
    set:
      tolerations:
        - key: "dedicated"
          operator: "Equal"
          value: "isoboot"
          effect: "NoSchedule"
    asserts:
      - equal:
          path: spec.template.spec.tolerations[0].key
          value: dedicated
      - equal:
          path: spec.template.spec.tolerations[0].effect
          value: NoSchedule

  - it: should set affinity when specified
    set:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: kubernetes.io/os
                    operator: In
                    values:
                      - linux
    asserts:
      - isNotNull:
          path: spec.template.spec.affinity.nodeAffinity

  - it: should set custom resources when specified
    set:
      controller.resources.limits.memory: 1Gi
      controller.resources.limits.cpu: "1"
      controller.resources.requests.memory: 512Mi
      controller.resources.requests.cpu: 500m
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 1Gi
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: "1"

  - it: should include component label
    asserts:
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/component"]
          value: controller
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/component"]
          value: controller

  # Negative Tests
  - it: should not include init container
    asserts:
      - isNull:
          path: spec.template.spec.initContainers

  - it: should not include PVC volume
    asserts:
      - isNull:
          path: spec.template.spec.volumes[0].persistentVolumeClaim

  - it: should fail when serviceAccount.create=false without name
    set:
      serviceAccount.create: false
      serviceAccount.name: ""
    asserts:
      - failedTemplate:
          errorMessage: "serviceAccount.name is required when serviceAccount.create is false"

  - it: should fail with empty image repository
    set:
      image.repository: ""
    asserts:
      - failedTemplate:
          errorMessage: "image.repository is required"

  - it: should fail with invalid pullPolicy
    set:
      image.pullPolicy: InvalidPolicy
    asserts:
      - failedTemplate:
          errorMessage: "image.pullPolicy must be one of: Always, IfNotPresent, Never"

  - it: should fail with replicaCount > 1 without leader election
    set:
      replicaCount: 2
      controller.leaderElection.enabled: false
    asserts:
      - failedTemplate:
          errorMessage: "replicaCount > 1 requires controller.leaderElection.enabled=true to avoid concurrent reconciliation conflicts"

  - it: should fail with invalid hostPath type
    set:
      storage.hostPath.type: InvalidType
    asserts:
      - failedTemplate:
          errorMessage: "storage.hostPath.type must be one of: Directory, DirectoryOrCreate, File, FileOrCreate, Socket, CharDevice, BlockDevice (or empty)"

  - it: should fail with relative hostPath path
    set:
      storage.hostPath.path: relative/path
    asserts:
      - failedTemplate:
          errorMessage: "storage.hostPath.path must be an absolute path (start with /)"
