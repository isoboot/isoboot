suite: rbac tests
templates:
  - templates/rbac.yaml
tests:
  # Positive Tests - Document count
  - it: should create ClusterRole, ClusterRoleBinding, Role, and RoleBinding
    asserts:
      - hasDocuments:
          count: 4

  # Positive Tests - ClusterRole
  - it: should create ClusterRole with correct name
    documentIndex: 0
    asserts:
      - isKind:
          of: ClusterRole
      - equal:
          path: metadata.name
          value: RELEASE-NAME-isoboot-manager-role

  - it: should grant bootsources permissions
    documentIndex: 0
    asserts:
      - contains:
          path: rules
          content:
            apiGroups:
              - isoboot.github.io
            resources:
              - bootsources
            verbs:
              - create
              - delete
              - get
              - list
              - patch
              - update
              - watch

  - it: should grant bootsources/status permissions
    documentIndex: 0
    asserts:
      - contains:
          path: rules
          content:
            apiGroups:
              - isoboot.github.io
            resources:
              - bootsources/status
            verbs:
              - get
              - patch
              - update

  - it: should grant bootsources/finalizers permissions
    documentIndex: 0
    asserts:
      - contains:
          path: rules
          content:
            apiGroups:
              - isoboot.github.io
            resources:
              - bootsources/finalizers
            verbs:
              - update

  # Positive Tests - ClusterRoleBinding
  - it: should create ClusterRoleBinding with correct name
    documentIndex: 1
    asserts:
      - isKind:
          of: ClusterRoleBinding
      - equal:
          path: metadata.name
          value: RELEASE-NAME-isoboot-manager-rolebinding

  - it: should reference correct ClusterRole
    documentIndex: 1
    asserts:
      - equal:
          path: roleRef.apiGroup
          value: rbac.authorization.k8s.io
      - equal:
          path: roleRef.kind
          value: ClusterRole
      - equal:
          path: roleRef.name
          value: RELEASE-NAME-isoboot-manager-role

  - it: should bind to correct service account
    documentIndex: 1
    asserts:
      - equal:
          path: subjects[0].kind
          value: ServiceAccount
      - equal:
          path: subjects[0].name
          value: RELEASE-NAME-isoboot
      - equal:
          path: subjects[0].namespace
          value: NAMESPACE

  # Positive Tests - Leader Election Role (namespaced)
  - it: should create leader election Role
    documentIndex: 2
    asserts:
      - isKind:
          of: Role
      - equal:
          path: metadata.name
          value: RELEASE-NAME-isoboot-leader-election-role
      - equal:
          path: metadata.namespace
          value: NAMESPACE

  - it: should grant leases permissions for leader election
    documentIndex: 2
    asserts:
      - contains:
          path: rules
          content:
            apiGroups:
              - coordination.k8s.io
            resources:
              - leases
            verbs:
              - create
              - delete
              - get
              - list
              - patch
              - update
              - watch

  - it: should grant configmaps permissions for leader election fallback
    documentIndex: 2
    asserts:
      - contains:
          path: rules
          content:
            apiGroups:
              - ""
            resources:
              - configmaps
            verbs:
              - create
              - delete
              - get
              - list
              - patch
              - update
              - watch

  - it: should grant events permissions in namespaced Role
    documentIndex: 2
    asserts:
      - contains:
          path: rules
          content:
            apiGroups:
              - ""
            resources:
              - events
            verbs:
              - create
              - patch

  # Positive Tests - Leader Election RoleBinding
  - it: should create leader election RoleBinding
    documentIndex: 3
    asserts:
      - isKind:
          of: RoleBinding
      - equal:
          path: metadata.name
          value: RELEASE-NAME-isoboot-leader-election-rolebinding
      - equal:
          path: metadata.namespace
          value: NAMESPACE

  - it: should reference correct leader election Role
    documentIndex: 3
    asserts:
      - equal:
          path: roleRef.apiGroup
          value: rbac.authorization.k8s.io
      - equal:
          path: roleRef.kind
          value: Role
      - equal:
          path: roleRef.name
          value: RELEASE-NAME-isoboot-leader-election-role

  - it: should bind leader election to correct service account
    documentIndex: 3
    asserts:
      - equal:
          path: subjects[0].kind
          value: ServiceAccount
      - equal:
          path: subjects[0].name
          value: RELEASE-NAME-isoboot
      - equal:
          path: subjects[0].namespace
          value: NAMESPACE

  # Tests with custom values
  - it: should use custom service account name in all bindings
    set:
      serviceAccount.name: custom-sa
    asserts:
      - documentIndex: 1
        equal:
          path: subjects[0].name
          value: custom-sa
      - documentIndex: 3
        equal:
          path: subjects[0].name
          value: custom-sa
